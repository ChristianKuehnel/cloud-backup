#!/bin/bash
set -eu

ROOTDIR="$(dirname $(cd "$(dirname "$0")" && pwd))"
CFGFILE=$ROOTDIR/backup.cfg
HOSTNAME=$(hostname)
LOGFILE=$ROOTDIR/backup.log
NEXTCLOUD_DB_DUMP=/tmp/nextcloud_database.bak

# functions #############
error() {
  printf '\E[31m'; echo "$@"; printf '\E[0m' | tee -a $LOGFILE
}

log() {
  echo "$(date --rfc-3339=seconds): $@" | tee -a $LOGFILE
}

failure() {
  error "Execution failed!"
  # TODO: disable maintenance mode if processing nextcloud 
  trap '' EXIT
  exit -1
}

backup_dir() {
  TARGETPATH=$BACKUP_TARGET/$HOSTNAME/$1
  log "Backing up $1 to $TARGETPATH ..."
  PASSPHRASE=""  duplicity --encrypt-sign-key $GPG_KEY_ID $1 $TARGETPATH | tee -a $LOGFILE
}

backup_dirs(){
  for d in ${SOURCE_DIRS[@]}
  do
    backup_dir $d
  done

}

nextcloud_maintenance_mode(){
  bash -c "cd /var/www/nextcloud;sudo -u www-data php occ maintenance:mode $1" | tee -a $LOGFILE
}

backup_nextcloud(){
  log "Creating backup of nextcloud instance in $1"
  if [ ! -d $1 ] ; then
    error "dir not found: $1"
    failure
  fi

  nextcloud_maintenance_mode  --on

  #TODO: get vars from config.php
  #mysqldump --single-transaction -h $dbhost -u $dbuser -p "$dbpassword" $dbname > $NEXTCLOUD_DB_DUMP
 
  #TODO: backup files + database

  rm $NEXTCLOUD_DB_DUMP 
  log "resuming nextcloud..."
  nextcloud_maintenance_mode --off 
  
}


# main #################
trap failure EXIT

if [ ! -f $CFGFILE ] ; then
  error "Config files does not exist: $CFGFILE"
  failure
fi

log "Using config file: $CFGFILE"
. $CFGFILE

if [ ! -z "${SOURCE_DIRS:-}" ] ; then
  backup_dirs
fi


if [ ! -z "${NEXTCLOUD_DIR:-}" ] ; then
  backup_nextcloud $NEXTCLOUD_DIR
fi

log "Done."
trap '' EXIT


